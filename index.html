<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
      background: black;
    }
    canvas {
      display: block;
    }
    button {
      user-select: none;
    }
  </style>
</head>
<body>
  <canvas id="c"></canvas>

  <!-- Movement D-Pad -->
  <div style="position:fixed;bottom:20px;left:20px;touch-action:none">
    <button id="left">‚¨ÖÔ∏è</button>
    <div>
      <button id="up">‚¨ÜÔ∏è</button>
      <button id="down">‚¨áÔ∏è</button>
    </div>
    <button id="right">‚û°Ô∏è</button>
  </div>

  <!-- Interact Button -->
  <button id="interact" style="
    position:fixed;
    bottom:90px;
    left:110px;
    width:64px;
    height:64px;
    background:rgba(255,255,255,0.2);
    border:none;
    border-radius:8px;
    color:white;
    font-size:16px;
    display:none;
    user-select:none;
  ">üëã</button>

  <script type="module">
    import * as Y from "https://esm.sh/yjs@13";
    import { WebrtcProvider } from "https://esm.sh/y-webrtc@10";
    import { Awareness } from "https://esm.sh/y-protocols/awareness";

    const ydoc = new Y.Doc();
    const provider = new WebrtcProvider("cool-room", ydoc);
    const awareness = provider.awareness;

    const canvas = document.getElementById("c");
    const ctx = canvas.getContext("2d");

    let width = canvas.width = innerWidth;
    let height = canvas.height = innerHeight;

    let username = localStorage.getItem("name") || prompt("name?");
    localStorage.setItem("name", username);
    awareness.setLocalStateField("name", username);

    const size = 30;
    const players = {};
    const colliding = {};

    const buttons = {
      up: false,
      down: false,
      left: false,
      right: false
    };

    let interactPressed = false;
    let interactCooldown = false;

    const interactBtn = document.getElementById("interact");
    interactBtn.addEventListener("touchstart", e => {
      e.preventDefault();
      if (!interactCooldown) interactPressed = true;
    });

    function loop() {
      ctx.clearRect(0, 0, width, height);
      let me = players[username];
      if (!me) return requestAnimationFrame(loop);

      // Movement
      if (buttons.left) me.x -= 1;
      if (buttons.right) me.x += 1;
      if (buttons.up) me.y -= 1;
      if (buttons.down) me.y += 1;

      awareness.setLocalStateField("pos", { x: me.x, y: me.y });

      // Interact logic
      if (interactPressed && !interactCooldown) {
        interactPressed = false;
        interactCooldown = true;

        for (let name in players) {
          if (name === username) continue;
          const other = players[name];

          const dx = me.x - other.x;
          const dy = me.y - other.y;
          const overlap = Math.abs(dx) < size && Math.abs(dy) < size;

          if (overlap) {
            other.say = { text: "hi", alpha: 1.0 };
            break;
          }
        }

        setTimeout(() => interactCooldown = false, 500);
      }

      // Smoothing & Rendering
      for (let name in players) {
        const p = players[name];

        // Smooth movement
        p.smoothX += (p.x - p.smoothX) * 0.2;
        p.smoothY += (p.y - p.smoothY) * 0.2;

        // Draw body
        ctx.fillStyle = colliding[name]
          ? (name === username ? "#fa0" : "#f00")
          : (name === username ? "#0f0" : "#0ff");
        ctx.fillRect(p.smoothX, p.smoothY, size, size);

        // Border
        ctx.strokeStyle = "#fff";
        ctx.strokeRect(p.smoothX, p.smoothY, size, size);

        // Name
        ctx.fillStyle = "#fff";
        ctx.font = "10px sans-serif";
        ctx.fillText(name, p.smoothX, p.smoothY - 4);

        // "hi" message
        if (p.say && p.say.alpha > 0) {
          ctx.fillStyle = `rgba(255,255,255,${p.say.alpha})`;
          ctx.font = "12px sans-serif";
          ctx.fillText(p.say.text, p.smoothX, p.smoothY - 16);
          p.say.alpha -= 0.02;
        }
      }

      // Collision detection
      for (let name in players) colliding[name] = false;

      for (let a in players) {
        for (let b in players) {
          if (a === b) continue;
          const pa = players[a];
          const pb = players[b];
          const dx = pa.x - pb.x;
          const dy = pa.y - pb.y;
          const overlap = Math.abs(dx) < size && Math.abs(dy) < size;
          if (overlap) {
            colliding[a] = colliding[b] = true;
          }
        }
      }

      requestAnimationFrame(loop);
    }

    function start() {
      document.getElementById("interact").style.display = "block";
      window.addEventListener("keydown", e => {
        if (e.key === "ArrowUp" || e.key === "w") buttons.up = true;
        if (e.key === "ArrowDown" || e.key === "s") buttons.down = true;
        if (e.key === "ArrowLeft" || e.key === "a") buttons.left = true;
        if (e.key === "ArrowRight" || e.key === "d") buttons.right = true;
        if (e.key.toLowerCase() === "e" && !interactCooldown) interactPressed = true;
      });

      window.addEventListener("keyup", e => {
        if (e.key === "ArrowUp" || e.key === "w") buttons.up = false;
        if (e.key === "ArrowDown" || e.key === "s") buttons.down = false;
        if (e.key === "ArrowLeft" || e.key === "a") buttons.left = false;
        if (e.key === "ArrowRight" || e.key === "d") buttons.right = false;
      });

      ["up", "down", "left", "right"].forEach(dir => {
        const btn = document.getElementById(dir);
        btn.addEventListener("touchstart", () => buttons[dir] = true);
        btn.addEventListener("touchend", () => buttons[dir] = false);
        btn.addEventListener("touchcancel", () => buttons[dir] = false);
        btn.addEventListener("contextmenu", e => e.preventDefault());
      });

      loop();
    }

    awareness.on("change", () => {
      const states = awareness.getStates();
      for (let [id, state] of states) {
        const name = state.name;
        const pos = state.pos || { x: 0, y: 0 };
        if (!players[name]) {
          players[name] = {
            x: pos.x,
            y: pos.y,
            smoothX: pos.x,
            smoothY: pos.y,
            say: null
          };
        } else {
          players[name].x = pos.x;
          players[name].y = pos.y;
        }
      }
    });

    start();
  </script>
</body>
</html>
